<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<style>
    body {
        background-color: #8A1D12;
    }

    h1 {
        color: #DAC09C;
    }
</style>

</html>

<body>
    <h1>INFO 3300 Project 2</h1>
    <p style="color:#DAC09C"><strong>Group member:</strong> Xinyi Zhou(xz255)</p>

    <!-- Create a svg for China map -->
    <div style="display: flex; flex-direction: row;">
        <svg id="china" width="700" height="700" style="margin-left:50px;"></svg>
        <div>
            <div id="yearLine" style="height:2; background-color:#F4F8F1;"></div>
            <div id="yearBar"></div>
        </div>
        <div id="topicButtons"></div>
    </div>
    <script>
        const chinaMap = d3.select("#china");
        const width = chinaMap.attr("width");
        const height = chinaMap.attr("height");
        const margins = { top: 50, right: 10, bottom: 10, left: 10 };
        const chinaMapWidth = width - margins.left - margins.right;
        const chinaMapHeight = height - margins.top - margins.bottom;

        let chinaMapArea = chinaMap.append("g")
            .attr("transform", `translate(${margins.left},${margins.top})`);

            const requestData = async () => {
    // Load topojson file of China
    const china = await d3.json("dataset/topochina.json");
    const regionList = ["安徽Anhui", "北京Beijing", "福建Fujian", "甘肃Gansu", "广东Guangdong", "广西Guangxi",
        "贵州Guizhou", "海南Hainan", "河北Hebei", "黑龙江Heilongjiang", "河南Henan", "香港Xianggang", "湖北Hubei",
        "湖南Hunan", "江苏Jiangsu", "江西Jiangxi", "吉林Jilin", "辽宁Liaoning", "澳门Aomen", "内蒙古Inner Mongolia",
        "宁夏Ningxia", "青海Qinghai", "陕西Shaanxi", "山东Shandong", "上海Shanghai", "山西Shanxi", "台湾Taiwan", "天津Tianjin",
        "新疆Xinjiang", "西藏Tibet", "云南Yunnan", "浙江Zhejiang", "重庆Chongqing", "四川Sichuan"];
    
    var region = topojson.feature(china, china.objects["regions.geo"]);

    // Load data files
    var population = await d3.csv("dataset/population.csv");
    var grp = await d3.csv("dataset/GRP.csv");

    // Convert year data to integers
    population.forEach(d => {
        for (const key in d) {
            if (!isNaN(key)) {
                d[key] = parseInt(d[key], 10);
            }
        }
    });

    grp.forEach(d => {
        for (const key in d) {
            if (!isNaN(key)) {
                d[key] = parseInt(d[key], 10);
            }
        }
    });

    // Initialize selectedYear and selectedTopic variables
    let selectedYear = "2020";  // Default year
    let selectedTopic = "population"; // Default topic

    function updateMapColors() {
        // Get data and color scale based on selected topic and year
        const data = selectedTopic === "population" ? population : grp;
        const extent = d3.extent(data, d => d[selectedYear]);
        
        const colorScale = d3.scaleQuantile()
            .domain(extent)
            .range(["#BD0026", "#f03b20", "#fd8d3c", "#FECC5C", "#ffeda0"]);

        // Update map colors based on region data
        chinaMapArea.selectAll("path.region")
            .data(region.features)
            .join("path")
            .attr("class", "region")
            .attr("d", path)
            .style("fill", d => {
                const regionData = data.find(item => item.Region === regionList[d.index]);
                return regionData ? colorScale(regionData[selectedYear]) : "lightgrey";
            });
    }

    function yearBarsAnimated(yearKey) {
        selectedYear = yearKey;  // Update selected year
        updateMapColors();  // Re-render map with updated year data
    }

    function topicAnimated(topicKey) {
        selectedTopic = topicKey;  // Update selected topic
        updateMapColors();  // Re-render map with updated topic data
    }

    // Create year buttons
    yearList.forEach(d => {
        d3.select("#yearBar")
            .append("button")
            .text(d)
            .on("click", function () {
                yearBarsAnimated(d);
            });
    });

    // Create topic buttons
    topicList.forEach(d => {
        d3.select("#topicButtons")
            .append("button")
            .text(d)
            .on("click", function () {
                topicAnimated(d);
            });
    });

    // Initialize projection for the map
    var projection = d3.geoMercator().fitSize([chinaMapWidth, chinaMapHeight], region);
    var path = d3.geoPath().projection(projection);

    // Draw the map
    chinaMapArea.selectAll("path.region")
        .data(region.features)
        .join("path")
        .attr("class", "region")
        .attr("d", path)
        .style("fill", "lightgrey")
        .on("mouseover", function (event, d) {
            d3.select(this).style("fill", "red");
            chinaMapArea.append("text")
                .attr("x", chinaMapWidth / 2)
                .attr("y", chinaMapHeight / 2)
                .attr("class", "regionText")
                .attr("color", "black")
                .text(regionList[d.index]);
        })
        .on("mouseout", function () {
            d3.select(this).style("fill", "lightgrey");
            chinaMapArea.selectAll(".regionText").remove();
        });

    updateMapColors(); // Initial render with default settings
};

requestData();

    </script>
</body>