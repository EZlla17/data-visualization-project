<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<style>
    body {
        background-color: #F4F8F1;
    }

    h1 {
        color: #50150A;
    }

    .outline {
            fill: none;
            stroke: #50150A;
            stroke-width: 1px;
        }
</style>

</html>

<body>
    <h1>INFO 3300 Project 2</h1>
    <p style="color:#50150A"><strong>Group member:</strong> Xinyi Zhou(xz255)</p>

    <!-- Create a svg for China map -->
    <div style="display: flex; flex-direction: row;">
        <svg id="china" width="700" height="700" style="margin-left:50px;"></svg>
        <div>
            <div id="yearLine" style="height:2; background-color:#F4F8F1;"></div>
            <div id="yearBar"></div>
        </div>
        <div id="topicButtons"></div>
    </div>
    <script>
        const chinaMap = d3.select("#china");
        const width = chinaMap.attr("width");
        const height = chinaMap.attr("height");
        const margins = { top: 50, right: 10, bottom: 10, left: 10 };
        const chinaMapWidth = width - margins.left - margins.right;
        const chinaMapHeight = height - margins.top - margins.bottom;

        let chinaMapArea = chinaMap.append("g")
            .attr("transform", `translate(${margins.left},${margins.top})`);

        const requestData = async () => {

            // Load topo json file of China
            const china = await d3.json("dataset/topochina.json");
            console.log(china);
            const regionList = ["Anhui", "Beijing", "Fujian", "Gansu", "Guangdong", "Guangxi",
                "Guizhou", "Hainan", "Hebei", "Heilongjiang", "Henan", "HongKong", "Hubei",
                "Hunan", "Jiangsu", "Jiangxi", "Jilin", "Liaoning", "Macao", "Inner Mongolia",
                "Ningxia", "Qinghai", "Shaanxi", "Shandong", "Shanghai", "Shanxi", "Taiwan", "Tianjin",
                "Xinjiang", "Tibet", "Yunnan", "Zhejiang", "Chongqing", "Sichuan"]
            var region = topojson.feature(china, china.objects["regions.geo"]);
            var regionMesh = topojson.mesh(china, china.objects["regions.geo"]);
            console.log(region);

            //Create a year list
            const yearList = ["2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"]
            //Create a topic list
            const topicList = ["population", "GRP"]

            //Load population file
            var population = await d3.csv("dataset/population.csv");
            //Change the year data from string to int
            population.forEach(d => {
                for (const key in d) {
                    if (!isNaN(key)) {
                        d[key] = parseInt(d[key], 10);
                    }
                }
            });

            //Load the GRP file
            var grp = await d3.csv("dataset/GRP.csv");
            //Change the GRP data from string to int
            grp.forEach(d => {
                for (const key in d) {
                    if (!isNaN(key)) {
                        d[key] = parseInt(d[key], 10);
                    }
                }
            });

            console.log(population);
            console.log(grp);


            region.features.forEach((feature, i) => {
                feature.index = i;
            });

            //create projection for the map
            var projection = d3.geoMercator().fitSize([chinaMapWidth, chinaMapHeight], region);
            var path = d3.geoPath().projection(projection);
            console.log(path)


            chinaMapArea.selectAll("path.region").data(region.features)
                .join("path")
                .attr("class", "region")
                .attr("d", path)
                .style("fill", "lightgrey")
                .on("mouseover", function (event, d) {
                    d3.select(this).style("fill", "red");
                    chinaMapArea.append("text")
                        .attr("x", chinaMapWidth / 2)
                        .attr("y", chinaMapHeight / 2)
                        .attr("class", "regionText")
                        .attr("color", "black")
                        .text(regionList[d.index]);
                })
                .on("mouseout", function () {
                    d3.select(this).style("fill", "lightgrey");
                    chinaMapArea.selectAll(".regionText").remove();
                });

            let selectedYear = "2020";
            let selectedTopic = "GRP";

            function updateMapColors() {
                var data;
                if (selectedTopic === "population") {
                    data = population;
                } else if (selectedTopic === "GRP") {
                    data = grp;
                }

                let allData = [];
                data.forEach(element => {
                    for (const key in element) {
                        if (yearList.includes(key)) {
                            allData.push(element[key]);
                        }
                    }
                });



                const extent = d3.extent(allData);
                console.log(extent);

                const colorScale = d3.scaleQuantile()
                    .domain(extent)
                    .range(["#bd0026", "#f03b20", "#fd8d3c", "#feb24c", "#fed976","#ffffb2"]);

                chinaMapArea.selectAll("path.topicPath")
                    .data(region.features)
                    .join("path")
                    .attr("class", "topicPath")
                    .attr("d", path)
                    .style("fill", d => {
                        const regionData = data.find(element => element["Region"] === regionList[d.index]);
                        if (regionData != undefined) {
                            console.log(regionData[selectedYear]);
                            return colorScale(regionData[selectedYear])
                        }

                    });
            }

            function topicAnimated(topicKey) {
                selectedTopic = topicKey;
                updateMapColors();
            }

            function yearBarsAnimated(yearKey) {
                selectedYear = yearKey;
                updateMapColors();

            }

            yearList.forEach(d => {
                d3.select("#yearBar")
                    .append("button")
                    .text(d)
                    .on("click", function () {
                        yearBarsAnimated(d);
                    })
            });

            topicList.forEach(d => {
                d3.select("#topicButtons")
                    .append("button")
                    .text(d)
                    .on("click", function () {
                        topicAnimated(d);
                    })
            })

            updateMapColors();

            chinaMapArea.append("path").datum(regionMesh)
                .attr("class", "outline")
                .attr("d", path);
        }
        requestData();

    </script>
</body>